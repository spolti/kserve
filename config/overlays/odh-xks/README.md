# xks Overlay for KServe

This overlay configures KServe for non-OpenShift Kubernetes environments
(EKS, GKE, AKS, vanilla K8s) based on the ODH overlay.

## Prerequisites

The following components must be installed before deploying this overlay:

- **cert-manager** - for certificate management
- **Istio** - with Gateway API support enabled (`PILOT_ENABLE_GATEWAY_API=true`)
- **Gateway API CRDs** - standard install
- **LeaderWorkerSet (LWS)** - for multi-node LLM workloads

For automated setup on KinD (used in CI), see:
[`test/scripts/kind/setup-odh-xks.sh`](../../../test/scripts/kind/setup-odh-xks.sh)

## Installation

```bash
kustomize build config/overlays/odh-xks | kubectl apply --server-side -f -
```

## Configuration

### InferenceService Config

The main configuration is in [`patches/patch-inferenceservice-config.yaml`](patches/patch-inferenceservice-config.yaml).
Key settings:

| Setting                | Description                                                   |
|------------------------|---------------------------------------------------------------|
| `kserveIngressGateway` | Gateway reference (default: `$(NAMESPACE)/inference-gateway`) |

### Gateway

The overlay uses Gateway API. Ensure you have a Gateway resource that
matches the `kserveIngressGateway` setting.

### TLS Architecture

The overlay uses a pluggable cert-manager architecture with OpenDataHub-scoped CA
(can be shared by other ODH components):

```
opendatahub-selfsigned-issuer (ClusterIssuer)
    └── opendatahub-ca (Certificate in cert-manager namespace)
            └── opendatahub-ca-issuer (ClusterIssuer using the CA)
                    ├── serving-cert (webhook certificate)
                    └── LLM workload certs (generated by controller)
```

The CA-related resources are defined in [`config/overlays/odh-test/cert-manager/`](../odh-test/cert-manager/)
and are expected to be created by the operator, Helm chart, or installer.

- `opendatahub-selfsigned-issuer`: Bootstrap ClusterIssuer (replace with Vault/Let's Encrypt for production)
- `opendatahub-ca`: CA certificate in `cert-manager` namespace
- `opendatahub-ca-issuer`: ClusterIssuer that signs workload certificates

## Key Differences from ODH Overlay

| Component                  | ODH (OpenShift)           | xks (vanilla K8s) |
|----------------------------|---------------------------|-------------------|
| SecurityContextConstraints | Included                  | Removed           |
| Certificate Management     | OpenShift service-ca      | cert-manager      |
| Ingress                    | Istio VirtualService      | Gateway API       |
| Webhook CA Injection       | service.beta.openshift.io | cert-manager.io   |
| LLM Workload TLS CA        | openshift-service-ca      | cert-manager CA   |

## Known Limitations

### ClusterRole contains OCP API references

The `kserve-controller-manager` ClusterRole includes a rule granting permission
to use `securitycontextconstraints` from the `security.openshift.io` API group.
This rule is harmless on non-OCP clusters (the API doesn't exist), but generates
a warning. Removing it by index is fragile;